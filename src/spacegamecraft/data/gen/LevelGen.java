package spacegamecraft.data.gen;

import java.awt.Image;
import java.awt.image.BufferedImage;
import java.util.ArrayList;
import java.util.Random;

import javax.swing.ImageIcon;
import javax.swing.JOptionPane;

import spacegamecraft.data.Empire;
import spacegamecraft.data.Galaxy;
import spacegamecraft.data.SpaceObject;
import spacegamecraft.data.System;
import spacegamecraft.geo.Point;
import spacegamecraft.gfx.Buffer;
import spacegamecraft.gfx.Color;

public class LevelGen {
	/**
	 * The max number of systems in a galaxy
	 */
	public static final int MAX_SYSTEMS = 100;
	/**
	 * Maximum number of objects in a system.
	 */
	public static final int MAX_OBJECTS = 10;

	/**
	 * Max length of the names generated by the name generator.
	 */
	private static final int PLANET_NAME_LENGTH = 10;

	/**
	 * Number of empires
	 */
	private static final int MAX_EMPIRES = 10;

	/**
	 * This is the change of an empire existing in a system. The change is 1 in EMPIRE_CHANCE
	 */
	private static int EMPIRE_CHANCE = 100;

	/**
	 * Generate a galaxy.
	 * @param rand, the instance of Random you want to use.
	 * @return a Galaxy.
	 */
	public static Galaxy generateGalaxy(Random rand) {
		// Generate Systems
		ArrayList<System> systems = new ArrayList<System>();
		for(int x=0; x < MAX_SYSTEMS; x++) {
			systems.add(generateSystem(rand));
		}
		
		// Generate Empires
		ArrayList<Empire> empires = new ArrayList<Empire>();
		for(int i=0; i<rand.nextInt(MAX_EMPIRES); i++) {
			Empire empire = generateEmpire(rand);
			
			// Now we iterate through all the systems to find the homeworld.
			for(int isys=0; isys<systems.size(); isys++) {
				System sys = systems.get(isys);
				
				// Gotta make sure it isn't owned, and gotta add some randomness.
				if(!sys.owned() && rand.nextInt(EMPIRE_CHANCE) == 0) {
					// This is the starting system of this empire.
					empire.owned_systems.add(sys);
					systems.get(isys).owner = empire;

					// Now we find the nearby systems. All the systems in range
					// belong to the empire.
					for(int isys2=0; isys2<systems.size(); isys2++) {
						System sec_system = systems.get(isys2);
						if(sys.loc.distance(sec_system.loc) < empire.influenceDistance()) {
							empire.owned_systems.add(sec_system);
							sec_system.owner = empire;
						}
					}

				}
			}
			empires.add(empire);

		}

		return new Galaxy(systems, empires);
	}
	/**
	 * Generate a system with a random location
	 * @param rand
	 * @return a System
	 */
	public static System generateSystem(Random rand) {
		return generateSystem(new Point(rand.nextInt(Galaxy.WIDTH), rand.nextInt(Galaxy.HEIGHT)), rand);
	}

	/**
	 * Generates a system at the specified point.
	 * @param loc, the location of the system in the Galaxy
	 * @param rand, the Random instance
	 * @return a System.
	 */
	public static System generateSystem(Point loc, Random rand) {
		ArrayList<SpaceObject> objects = new ArrayList<SpaceObject>();

		for(int number_objects = rand.nextInt(MAX_OBJECTS); number_objects > 0; number_objects--) {
			objects.add(generateObject(rand));
		}
		int system_size = rand.nextInt(3);

		return new System(loc, system_size, Gpw.generate(rand.nextInt(PLANET_NAME_LENGTH-3)+3, rand), objects);
	}

	/**
	 * Generate a SpaceObject with a random name.
	 * @param rand, the Random instance
	 * @return a Space Object
	 */
	public static SpaceObject generateObject(Random rand) {
		return new SpaceObject(Gpw.generate(rand.nextInt(PLANET_NAME_LENGTH-3)+3, rand));
	}

	/**
	 * Randomly generates a planet name by stringing together randomly chosen letters.
	 * Alphabet includes a "'", vowels are weighted double. Now replaced by Gpw.
	 * @param rand, the Random instance
	 * @return a String with the generated name.
	 */
	@Deprecated
	public static String randomPlanetName(Random rand) {
		String[] characters = "abcdefghijklmnopqrstuvwxyz'aioue".split("");
		StringBuilder result = new StringBuilder();
		for(int length=rand.nextInt(PLANET_NAME_LENGTH-3)+3; length > 0; length--) {
			result.append(characters[rand.nextInt(characters.length)]);
		}

		return result.toString();
	}

	/**
	 * Generates a new empire with random name, color, and size.
	 * @param rand
	 * @return
	 */
	public static Empire generateEmpire(Random rand) {
		return new Empire(Gpw.generate(PLANET_NAME_LENGTH, rand), Color.randColor(rand), rand.nextInt(Empire.MAX_EMPIRE_SIZE));
	}

	/**
	 * Randomly generates a galaxy (random seed). Displays all the planets with the alegiences and
	 * space objects. Also displays empires and their holdings
	 * @param args
	 */
	public static void main(String[] args) {
		int width = Galaxy.WIDTH;
		int height = Galaxy.HEIGHT;

		for(int i=0; i < 1; i++) { // Increase the 1 to get more galaxies. Set to 0 for infinite.
			// Made a new image.
			BufferedImage img = new BufferedImage(width+1, height+1, BufferedImage.TYPE_INT_RGB);
			
			// Make a buffer to play with
			Buffer buf = new Buffer(width, height);
			
			// Generate the galaxy.
			Galaxy gal = LevelGen.generateGalaxy(new Random());
			
			// Start the textual data dump. First, iterate through the systems
			for(int s=0; s<gal.systems.size(); s++) {
				System sys = gal.systems.get(s);
				java.lang.System.out.println(sys.name + ((sys.owned()) ? ("[" + sys.owner.name + "]") : ""));
				
				// Then the objects in those systems. Indent to make reading easier.
				for(int o=0; o<sys.objects.size(); o++) {
					SpaceObject obj = sys.objects.get(o);
					java.lang.System.out.println("    " + obj.name);
				}
			}


			// Draw the galaxy onto the buffer.
			buf = gal.draw(new Point(0, 0), buf);
			
			// Draw the buffer onto the image.
			buf.drawOnImage(img);
			
			// Launch a message dialog with the image at double size.
			JOptionPane.showMessageDialog(null,
					null,
					"Another",
					JOptionPane.OK_CANCEL_OPTION,
					new ImageIcon(img.getScaledInstance(width*2, height*2, Image.SCALE_AREA_AVERAGING)));
		}
		java.lang.System.exit(0);
	}
}
